<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <script type="text/javascript" src="/assets/util/areacontrol.js"></script>
    <script type="text/javascript" src="/assets/util/audio.js"></script>
    <script type="text/javascript" src="/assets/util/timer.js"></script>
    <script type="text/javascript" src="/assets/util/popup.js"></script>
    <script type="text/javascript" src="/assets/util/scrollbar.js"></script>
    <link rel="stylesheet" href="/assets/util/default.css">
    <link rel="stylesheet" href="/assets/util/popup.css">
    <link rel="stylesheet" href="/assets/util/scrollbar.css">
    <link rel="stylesheet" href="/assets/css/default.css">
    <link rel="stylesheet" href="/assets/css/area.css">
    <link rel="stylesheet" href="/assets/css/chat.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Quiz Game App</title>
</head>

<body class="default_text">
    <div id="Area_Top">
        <div id="showClock" class="shadow"></div>
        <button id="connectsBtn" class="Btn action_button default_text small_text">æ¥ç¶š:<span
                id="connectedClients">0</span>äºº</button>
        <button id="answeredBtn" class="Btn action_button default_text small_text">å›ç­”:<span
                id="answeredClients">0</span>äºº</button>
        <button id="muteBtn" class="Btn action_button default_text small_text" onclick="mute(this)">ğŸ”‡æ¶ˆéŸ³</button>
        <button id="clientNameDisplay" class="Btn action_button default_text small_text">ç®¡ç†è€…</button>
    </div>
    <div id="Area_Tab">
        <div class="Item_Tab_Area">
            <button id="Item_TabA" class="Item_Tab FullSize Btn default_text Selected"
                onclick="selectTab('Area_Show', 'Item_Tab', 'A');">ã‚¯ã‚¤ã‚º</button>
        </div>
        <div class="Item_Tab_Area">
            <button id="Item_TabB" class="Item_Tab FullSize Btn default_text"
                onclick="selectTab('Area_Show', 'Item_Tab', 'B');">é †ä½</button>
        </div>
        <div class="Item_Tab_Area">
            <button id="Item_TabC" class="Item_Tab FullSize Btn default_text"
                onclick="selectTab('Area_Show', 'Item_Tab', 'C');">ãƒãƒ£ãƒƒãƒˆ</button>
        </div>
    </div>
    <div id="Area_ShowA" class="Area_Show">
        <div id="Area_GameAction">
            <button class="Btn default_text" onclick="prevQuestion()">-</button>
            <span id="questionNumber" class="default_text">ä¾‹é¡Œ</span>
            <button class="Btn default_text" onclick="nextQuestion()">+</button>
            <select id="choiceAnswer" class="Btn default_text" name="choiceAnswer">
                <option value="A">ç­”ãˆ: A</option>
                <option value="B">ç­”ãˆ: B</option>
                <option value="C">ç­”ãˆ: C</option>
                <option value="D">ç­”ãˆ: D</option>
                <option value="null">å¤šæ•°æ±º</option>
            </select>
            <button class="Btn default_text" onclick="subTimer()">-</button>
            <span id="timerNumber" class="default_text">100ç§’</span>
            <button class="Btn default_text" onclick="addTimer()">+</button>
            <button class="Btn default_text" onclick="sendQuestionByHost()">å‡ºé¡Œ</button>
            <button class="Btn default_text" onclick="stopQuestionByHost()">ç· åˆ‡</button>
            <button class="Btn default_text" onclick="sendAnswerByHost()">çµæœ</button>
            <!-- <button class="Btn default_text" onclick="showRankByHost()">é †ä½</button>
            <button class="Btn default_text"
                onclick="showAlert('ç¢ºèª','çµæœã‚’åˆæœŸåŒ–ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹?','confirm','resetQuestion()')">åˆæœŸåŒ–</button> -->
        </div>
        <input id="Area_GameQuestion" class="default_text"></input>
        <div id="Area_GameAnswer">
            <input id='Item_AnswerA' class='Btn Item_AnswerTile default_text'></input>
            <input id='Item_AnswerB' class='Btn Item_AnswerTile default_text'></input>
            <input id='Item_AnswerC' class='Btn Item_AnswerTile default_text'></input>
            <input id='Item_AnswerD' class='Btn Item_AnswerTile default_text'></input>
        </div>
        <div id="Area_GameSelect">
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('input')">å…¥åŠ›</button>
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('1')">Q01</button>
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('2')">Q02</button>
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('3')">Q03</button>
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('4')">Q04</button>
            <button class="Item_GameSelect Btn default_text" onclick="selectQuestion('5')">Q05</button>
        </div>
    </div>
    <div id="Area_ShowB" class="Area_Show" style="display: none;">
        <div id="Area_GameAction">
            <button class="Btn default_text" onclick="showRankByHost()">é †ä½</button>
            <button class="Btn default_text"
                onclick="showAlert('ç¢ºèª','çµæœã‚’åˆæœŸåŒ–ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹?','confirm','resetQuestion()')">åˆæœŸåŒ–</button>
        </div>
        <div id="Area_RankDisplay"></div>
    </div>
    <div id="Area_ShowC" class="Area_Show" style="display: none;">
        <div id="Area_ChatDisplay"></div>
        <div id="Area_ChatInput">
            <div class="Chat_Select Chat_SelectL">
                <input type="radio" id="messageToAll" name="messageTo" value="All" checked>
                <label for="messageToAll">å…¨ä½“å‘ã‘</label>
            </div>
            <div class="Chat_Select Chat_SelectR">
                <input type="radio" id="messageToHost" name="messageTo" value="Host" disabled>
                <label for="messageToHost">ç®¡ç†è€…å‘ã‘</label>
            </div>
            <input type="text" id="message" name="message" class="Chat_Input" required>
            <button class="Chat_Submit Btn default_text" onclick="sendChat()">é€ä¿¡</button>
        </div>
    </div>

    <style>
        #Area_GameAction {
            background-color: var(--use-color-c1);
            width: 100%;
            height: 5vh;
            position: absolute;
            top: 0vh;
            left: 50%;
            border: solid 3px white;
            transform: translate(-50%, -20%);
        }

        #Area_GameQuestion {
            background-color: var(--use-color-c1);
            width: 90vw;
            height: 14vh;
            position: absolute;
            top: 7vh;
            left: 50%;
            border: solid 3px white;
            transform: translate(-50%, 0%);
        }

        #Area_GameAnswer {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
            width: 90vw;
            height: 44vh;
            position: absolute;
            left: 50%;
            top: 24vh;
            transform: translate(-50%, 0%);
        }

        #Area_GameSelect {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
            background-color: var(--use-color-c1);
            width: 100%;
            height: 11vh;
            position: absolute;
            top: 70vh;
            left: 50%;
            border: solid 3px white;
            transform: translate(-50%, 0%);
        }

        .Item_AnswerTile {
            width: calc(45vw - 10px);
            height: 20vh;
        }

        .Item_GameSelect {
            width: 10vw;
            height: 5vh;
        }

        .Item_RankDisplay {
            width: 80vw;
            height: 8vh;
            position: relative;
            left: calc(10vw - 6px);
            top: 5vh;
            border-radius: 30px;
            background-color: var(--use-color-b1);
            border: solid 3px var(--use-color-a1);
        }
    </style>
    <script>
        setInterval('showClock("showClock")', 1000);

        var muting = true;
        function mute(obj) {
            if (muting == true) {
                muting = false;
                obj.innerHTML = "ğŸµé€šçŸ¥"
            } else if (muting == false) {
                stopAllAlarms();
                muting = true;
                obj.innerHTML = "ğŸ”‡æ¶ˆéŸ³";
            }
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
        const socket = io();
        socket.on('showChatToAll', (username, message) => {
            let myname = document.getElementById('clientNameDisplay').innerHTML
            if (username != myname) {
                banner('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡', `${username}ã•ã‚“: ${message}`);
                addChatTile("Other", "Me", username, message);
            } else {
                addChatTile("Me", "All", myname, message);
            }
        });
        socket.on('showChatToHost', (username, message) => {
            banner('DMå—ä¿¡', `${username}ã•ã‚“: ${message}`);
            addChatTile("Other", "Me", username, message);
        });
        socket.on('updateCount', (connectedClientsCount,answeredClientsCount) => {
            document.getElementById('connectedClients').innerText = connectedClientsCount;
            document.getElementById('answeredClients').innerText = answeredClientsCount;
        });
        socket.on('showResult', (result) => {
            const sumObj = {};
            for (const [key, value] of Object.entries(result)) {
                sumObj[key] = {
                    total: value.correctCount + value.speedBounus,
                    correctCount: value.correctCount,
                    speedBounus: value.speedBounus,
                    username: value.username
                };
            }

            const sortedArray = Object.entries(sumObj).sort((a, b) => b[1].total - a[1].total);
            resetItemInArea(['RankDisplay']);
            selectTab('Area_Show', 'Item_Tab', 'B');
            sortedArray.forEach(([key, value]) => {
                addRankTile(value.username, value.total, value.correctCount, value.speedBounus)
                console.log(`${value.username}:${value.total} (${value.correctCount},${value.speedBounus})`);
            });
        });
        socket.on('showRank', (result) => {
            const sumObj = {};
            for (const [key, value] of Object.entries(result)) {
                sumObj[key] = {
                    total: value.correctCount + value.speedBounus,
                    correctCount: value.correctCount,
                    speedBounus: value.speedBounus,
                    username: value.username
                };
            }

            const sortedArray = Object.entries(sumObj).sort((a, b) => b[1].total - a[1].total);
            resetItemInArea(['RankDisplay']);
            selectTab('Area_Show', 'Item_Tab', 'B');
            sortedArray.forEach(([key, value]) => {
                addRankTile(value.username, value.total, value.correctCount, value.speedBounus)
                // console.log(`${value.username}:${value.total} (${value.correctCount},${value.speedBounus})`);
            });
        });

        // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
        async function sendChat() {
            const message = document.getElementById('message').value;
            // const clientId = document.getElementById('clientIdDisplay').innerText;

            // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®valueã‚’å–å¾—
            var radioButtons = document.getElementsByName('messageTo');
            var messageTo;
            for (var i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                    messageTo = radioButtons[i].value;
                    break;
                }
            }
            // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            socket.emit(`/broadcastTo${messageTo}`, message);
            document.getElementById('message').value = '';
        }

        function addChatTile(From = "Host", To = "Me", Name, Message) {
            var ChatTile = document.createElement('div');
            if (From == "Me") {
                ChatTile.className = 'Item_ChatDisplay Chat_R';
            } else if (From == "Host") {
                ChatTile.className = 'Item_ChatDisplay Chat_L';
            } else if (From == "Other") {
                ChatTile.className = 'Item_ChatDisplay Chat_L';
            }
            const currentDate = new Date();
            const formattedTime = currentDate.toLocaleTimeString('en-US', { hour12: false });
            ChatTile.innerHTML = `${Name}ã•ã‚“ (${formattedTime})<br>${Message}`;
            document.getElementById('Area_ChatDisplay').appendChild(ChatTile);
        }
        function addRankTile(Name, Total, Correct, Bounus) {
            var RankTile = document.createElement('div');
            RankTile.className = 'Item_RankDisplay';
            RankTile.innerHTML = `${Name}ã•ã‚“ : ${Total}pt<br>(æ­£è§£æ•°:${Correct}pt,ãƒœãƒ¼ãƒŠã‚¹${Bounus}pt)`;
            document.getElementById('Area_RankDisplay').appendChild(RankTile);
        }

        let questionNumber = 0;
        let timerNumber = 100;
        function prevQuestion() {
            if (questionNumber > 0) {
                questionNumber--;
            }
            reflectQuestion();
        }
        function nextQuestion() {
            questionNumber++;
            reflectQuestion();
        }
        function reflectQuestion() {
            if (questionNumber == 0) {
                document.getElementById('questionNumber').innerHTML = 'ä¾‹é¡Œ';
            } else {
                document.getElementById('questionNumber').innerHTML = 'No.' + questionNumber
            }
        }
        function subTimer() {
            if (timerNumber >= 5) {
                timerNumber -= 5;
            }
            reflectTimer();
        }
        function addTimer() {
            timerNumber += 5;
            reflectTimer();
        }
        function reflectTimer() {
            if (timerNumber <= 0) {
                document.getElementById('timerNumber').innerHTML = 'ãªã—';
            } else {
                document.getElementById('timerNumber').innerHTML = timerNumber + 'ç§’'
            }
        }

        function getQuestion(){
            let Question = {
                "no": questionNumber,
                "question": document.getElementById('Area_GameQuestion').value,
                "answerA": document.getElementById('Item_AnswerA').value,
                "answerB": document.getElementById('Item_AnswerB').value,
                "answerC": document.getElementById('Item_AnswerC').value,
                "answerD": document.getElementById('Item_AnswerD').value,
                "timer": timerNumber,
            }
            return Question
        }
        function getAnswer(){
            let Answer = document.getElementById('choiceAnswer');
            let CorrectAnswer = Answer.options[Answer.selectedIndex].value;
            if (CorrectAnswer == 'null'){
                CorrectAnswer = null;
            }
            return CorrectAnswer
        }

        function sendQuestionByHost() {
            Question = getQuestion();
            CorrectAnswer = getAnswer();
            socket.emit('/sendQuestionByHost', Question, CorrectAnswer);
        }
        function stopQuestionByHost() {
            socket.emit('/stopQuestionByHost');
        }
        function sendAnswerByHost() {
            Question = getQuestion();
            CorrectAnswer = getAnswer();
            socket.emit('/sendAnswerByHost', Question, CorrectAnswer);
        }
        function showRankByHost() {
            socket.emit('/showRankByHost');
        }

        function updateCount() {
            socket.emit('/updateCount');
        }
        setInterval('updateCount()', 1000);

        let AnswerList = {
            "1": { "answer": 1 },
            "2": { "answer": 1 },
            "3": { "answer": 3 },
            "4": { "answer": 1 },
            "5": { "answer": 1 },
        }

        let QuestionList = {
            "1": {
                "question": "é£›è¡Œæ©Ÿã®æ©Ÿå†…é£Ÿç”¨ã«é–‹ç™ºã•ã‚ŒãŸé‡èœã¯ï¼Ÿ",
                "answerA": "ã‚¢ãƒœã‚«ãƒ‰",
                "answerB": "ãƒŸãƒ‹ãƒˆãƒãƒˆ",
                "answerC": "ãƒ‘ãƒ—ãƒªã‚«",
                "answerD": "èŠ½ã‚­ãƒ£ãƒ™ãƒ„",
                "timer": 10,
            },
            "2": {
                "question": "ç ‚ç³–ã¯æ˜”ã€ä½•ã«æ´»ç”¨ã•ã‚Œã¦ã„ãŸï¼Ÿ",
                "answerA": "é ­ç—›è–¬",
                "answerB": "é¢¨é‚ªè–¬",
                "answerC": "èƒƒç—›è–¬",
                "answerD": "è§£ç†±å‰¤",
                "timer": 20,
            },
            "3": {
                "question": "ã“ã¨ã‚ã–ã€Œæ€¥ãŒã°å›ã‚Œã€ã®èªæºã¨ãªã£ãŸå ´æ‰€ã¯ã©ã“ï¼Ÿ",
                "answerA": "å¯Œå£«å±±",
                "answerB": "æ¸…æ°´å¯º",
                "answerC": "å³å³¶ç¥ç¤¾",
                "answerD": "çµç¶æ¹–",
                "timer": 30,
            },
            "4": {
                "question": "ãŸã„ç„¼ãã¯å…ƒã€…é¯›ã§ã¯ãªãä½•ã®å½¢ã‚’ã—ã¦ã„ãŸï¼Ÿ",
                "answerA": "ã‚¯ãƒ",
                "answerB": "ã‚«ãƒ¡",
                "answerC": "ãƒ’ãƒ¨ã‚³",
                "answerD": "ãƒã‚³",
                "timer": 100,
            },
            "5": {
                "question": "é‡èœã®åå‰ãŒæ—¥æœ¬èªã§ã¯ãªã„ã‚‚ã®ã¯ï¼Ÿ",
                "answerA": "ãƒ¬ãƒ³ã‚³ãƒ³",
                "answerB": "ã‚ªã‚¯ãƒ©",
                "answerC": "ãƒ€ã‚¤ã‚³ãƒ³",
                "answerD": "ãƒã‚®",
                "timer": 100,
            },
        }


        function selectQuestion(No) {
            if (No == 'input') {
                questionNumber = 0;
                reflectQuestion();
                timerNumber = 10;
                reflectTimer();
                document.getElementById('Area_GameQuestion').value = '';
                document.getElementById('Item_AnswerA').value = '';
                document.getElementById('Item_AnswerB').value = '';
                document.getElementById('Item_AnswerC').value = '';
                document.getElementById('Item_AnswerD').value = '';
                document.getElementById('choiceAnswer').selectedIndex = 0;
            } else {
                questionNumber = parseInt(No, 10);
                reflectQuestion();
                timerNumber = QuestionList[No].timer;
                reflectTimer();
                document.getElementById('Area_GameQuestion').value = QuestionList[No].question;
                document.getElementById('Item_AnswerA').value = QuestionList[No].answerA;
                document.getElementById('Item_AnswerB').value = QuestionList[No].answerB;
                document.getElementById('Item_AnswerC').value = QuestionList[No].answerC;
                document.getElementById('Item_AnswerD').value = QuestionList[No].answerD;
                document.getElementById('choiceAnswer').selectedIndex = AnswerList[No].answer;
            }
        }
        // å›ç­”è¨˜éŒ²åˆæœŸåŒ–â€»æ³¨æ„
        function resetQuestion() {
            socket.emit('/resetQuestion');
        }

    </script>
</body>

</html>